<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Settings</title>
  <link rel="stylesheet" href="../dashboard/styles.css">
  <style>
    /* keep only minimal page-specific overrides */
    .setting-card-container{padding:28px}
    .btn{display:inline-block;margin-top:14px;padding:10px 14px;border-radius:10px;background:rgba(255,255,255,0.06);text-decoration:none;color:inherit}
  </style>
  <script>
    function applySavedTheme(){
      try{const saved=localStorage.getItem('theme');document.body.classList.toggle('light-theme',saved==='light')}catch(e){}
    }
    applySavedTheme();
    window.addEventListener('pageshow', applySavedTheme);
    function toggleTheme(){
      document.body.classList.toggle('light-theme');
      try{const isLight=document.body.classList.contains('light-theme');localStorage.setItem('theme',isLight?'light':'dark');}catch(e){}
    }
  </script>
</head>
<body>
  <!-- Reuse dashboard sidebar for consistent navigation -->
  <aside class="sidebar" id="sidebar" aria-label="Main sidebar">
    <div class="brand">
      <span class="logo" aria-hidden="true"></span>
      <div>
        <div style="font-size:15px;font-weight:700;color:var(--text)">Krushna Saruk</div>
        <div style="font-size:11px;color:var(--muted);margin-top:2px">Student ID: 3292957</div>
      </div>
    </div>

    <nav>
      <div class="nav-item" data-section="insights">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 13h4v8H3zM8.5 3h4v18h-4zM17 8h4v13h-4z" fill="currentColor" opacity="0.9"/></svg>
        <div class="nav-label">Attendance Insights</div>
      </div>

      <div class="nav-item" data-section="extracurricular">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" fill="currentColor" opacity="0.9"/></svg>
        <div class="nav-label">Extracurricular</div>
        <svg class="nav-toggle" width="14" height="14" viewBox="0 0 24 24"><path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" fill="none"/></svg>
      </div>
      <div class="nav-submenu" style="display:none;">
        <div class="nav-subitem" data-subsection="upcoming-events">Upcoming Events</div>
        <div class="nav-subitem" data-subsection="club-listings">Club Listings</div>
        <div class="nav-subitem" data-subsection="past-events">Past Event Gallery</div>
        <div class="nav-subitem" data-subsection="achievements">Student Achievements</div>
        <div class="nav-subitem" data-subsection="participation">Participation Records</div>
        <div class="nav-subitem" data-subsection="opportunities">Opportunities Board</div>
      </div>

      <div class="nav-item" data-section="settings">
        <svg width="18" height="18" viewBox="0 0 24 24"><path d="M12 8a4 4 0 100 8 4 4 0 000-8z" fill="currentColor" opacity="0.9"/></svg>
        <div class="nav-label">Settings</div>
      </div>
      <div class="nav-item" data-section="moodle">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 2L2 7v10c0 5.55 3.84 9.74 9 11 5.16-1.26 9-5.45 9-11V7l-10-5z" fill="currentColor" opacity="0.9"/></svg>
        <div class="nav-label">Moodle</div>
      </div>
    </nav>

    <div class="mobile-buttons">
      <button class="mobile-btn" id="mobileCalendarBtn">
        <svg width="16" height="16" viewBox="0 0 24 24"><path d="M7 11h10M3 7h18M7 3v4M17 3v4" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>
        Calendar
      </button>
      <button class="mobile-btn" id="mobileNotifBtn">
        <svg width="16" height="16" viewBox="0 0 24 24"><path d="M12 22a2 2 0 002-2H10a2 2 0 002 2zM18 16v-5a6 6 0 00-12 0v5l-2 2h16l-2-2z" fill="currentColor"/></svg>
        Alerts
      </button>
    </div>

    <div class="bottom muted">© <span id="year"></span> SchoolSystem</div>
  </aside>

  <div class="main">
    <main class="content-wrapper">
      <div class="setting-card-container">
        <main class="card">
          <h1 style="font-size:22px;margin-bottom:6px">Settings</h1>
          <p class="muted" style="margin-bottom:12px">Edit your profile and preferences. Changes are saved locally and reflected on the dashboard.</p>

          <form id="profileForm" style="display:grid;grid-template-columns:1fr 260px;gap:18px;align-items:start">
            <div>
              <label for="studentName">Full name</label>
              <input id="studentName" placeholder="Your name" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--surface);color:var(--text)" />

              <label for="studentEmail">Email</label>
              <input id="studentEmail" placeholder="name@college.edu" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--surface);color:var(--text)" />

              <label for="studentPhone">Phone</label>
              <input id="studentPhone" placeholder="+91 98765 43210" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--surface);color:var(--text)" />

              <label for="studentCourse">Course</label>
              <select id="studentCourse" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--surface);color:var(--text)">
                <option value="">Select course</option>
                <option value="btech">B.Tech</option>
                <option value="diploma">Diploma</option>
                <option value="mtech">M.Tech</option>
                <option value="bca">BCA</option>
              </select>

              <div style="display:flex;gap:8px;margin-top:12px">
                <button type="button" id="saveProfile" class="btn">Save</button>
                <button type="button" id="resetProfile" class="btn">Reset</button>
                <a class="btn" href="../dashboard/index.html">← Back</a>
              </div>
              <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
                <button type="button" id="downloadAttendance" class="btn">Download Attendance (CSV)</button>
                <button type="button" id="resetMonthAttendance" class="btn">Reset This Month</button>
                <div class="muted" style="font-size:12px">Download or reset monthly attendance data.</div>
              </div>
            </div>

            <div style="text-align:center">
              <div style="font-weight:700;margin-bottom:8px">Profile Picture</div>
              <div id="profilePreview" style="width:180px;height:180px;margin:0 auto;border-radius:12px;background:var(--hover);display:flex;align-items:center;justify-content:center;font-size:36px;color:var(--text);overflow:hidden">KS</div>
              <label for="profilePic" style="display:block;margin-top:10px">Image URL or upload</label>
              <input id="profilePic" placeholder="https://.../avatar.jpg" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--surface);color:var(--text)" />
              <input id="profileFile" type="file" accept="image/*" capture="environment" style="margin-top:8px;" />
              <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
                <button type="button" id="removeImage" class="btn">Remove Image</button>
                <div class="muted" style="font-size:12px">Tip: upload from device or paste a URL; mobile will offer gallery/camera.</div>
              </div>
            </div>
          </form>

        </main>
      </div>
    </main>
  </div>
  <script src="../dashboard/script.js"></script>
  <script>
    // Settings page logic: save profile to localStorage so dashboard reflects changes
    (function(){
      function $(id){return document.getElementById(id);} 
      function load(){
        try{
          const name = localStorage.getItem('studentName') || '';
          const pic = localStorage.getItem('profilePic') || '';
          const email = localStorage.getItem('studentEmail') || '';
          const phone = localStorage.getItem('studentPhone') || '';
          const course = localStorage.getItem('studentCourse') || '';
          $('studentName').value = name;
          $('profilePic').value = pic;
          $('studentEmail').value = email;
          $('studentPhone').value = phone;
          $('studentCourse').value = course;
          renderPreview();
        }catch(e){console.error(e)}
      }
      function save(){
        try{
          const name = $('studentName').value.trim();
          const pic = $('profilePic').value.trim();
          const email = $('studentEmail').value.trim().toLowerCase();
          const phone = $('studentPhone').value.trim();
          const course = $('studentCourse').value;
          localStorage.setItem('studentName', name);
          localStorage.setItem('profilePic', pic);
          localStorage.setItem('studentEmail', email);
          localStorage.setItem('studentPhone', phone);
          localStorage.setItem('studentCourse', course);
          // no per-account storage in this build — settings save only global profile keys

          alert('Profile saved. Changes will show on the dashboard.');
        }catch(e){console.error(e)}
      }
      function resetProfile(){
        if(!confirm('Reset profile to defaults?')) return;
        try{
          localStorage.removeItem('studentName');
          localStorage.removeItem('profilePic');
          localStorage.removeItem('studentEmail');
          localStorage.removeItem('studentPhone');
          localStorage.removeItem('studentCourse');
          load();
          alert('Profile reset.');
        }catch(e){console.error(e)}
      }
      function renderPreview(){
        const preview = $('profilePreview');
        const pic = $('profilePic').value.trim();
        const name = $('studentName').value.trim() || 'KS';
        if(pic){
          // create or update img
          let img = preview.querySelector('img');
          if(!img){ img = document.createElement('img'); img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover'; preview.textContent=''; preview.appendChild(img); }
          img.src = pic;
        } else {
          // show initials
          const initials = name.split(' ').map(n=>n[0]||'').join('').toUpperCase().slice(0,2);
          const img = preview.querySelector('img'); if(img) img.remove();
          preview.textContent = initials || 'KS';
        }
      }

      document.addEventListener('DOMContentLoaded', ()=>{
        load();
        $('profilePic').addEventListener('input', renderPreview);
        $('studentName').addEventListener('input', renderPreview);

        // Handle file input (gallery / camera on mobile). Read as DataURL and set as profilePic value.
        const profileFile = $('profileFile');
        if(profileFile){
          profileFile.addEventListener('change', (e)=>{
            const f = e.target.files && e.target.files[0];
            if(!f) return;
            const reader = new FileReader();
            reader.onload = function(ev){
              try{ $('profilePic').value = ev.target.result || ''; renderPreview(); }catch(err){console.error(err)}
            };
            reader.readAsDataURL(f);
          });
        }

        // Remove image button clears both URL input and file input, then updates preview
        const removeBtn = $('removeImage');
        if(removeBtn){
          removeBtn.addEventListener('click', ()=>{
            try{
              $('profilePic').value = '';
              if(profileFile) profileFile.value = '';
              renderPreview();
            }catch(e){console.error(e)}
          });
        }

        $('saveProfile').addEventListener('click', save);
        $('resetProfile').addEventListener('click', resetProfile);
        // Attendance export and monthly reset
        function exportAttendanceCSV(monthKey){
          try{
            const storageKey = 'attendanceByMonth';
            const by = JSON.parse(localStorage.getItem(storageKey) || '{}');
            monthKey = monthKey || new Date().toISOString().slice(0,7);
            const records = by[monthKey] || {};
            // CSV header
            let csv = 'Subject,Present,Sessions,Dates\n';
            Object.keys(records).forEach(subj=>{
              const r = records[subj];
              const dates = (r.dates||[]).join('|');
              csv += `"${subj}",${r.present||0},${r.sessions||0},"${dates}"\n`;
            });
            if(Object.keys(records).length===0){ alert('No attendance data for ' + monthKey); return; }
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `attendance-${monthKey}.csv`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
          }catch(e){console.error(e); alert('Failed to export attendance.');}
        }

        function resetThisMonthAttendance(){
          if(!confirm('Reset attendance for the current month? This will clear all records for this month.')) return;
          try{
            const storageKey = 'attendanceByMonth';
            const by = JSON.parse(localStorage.getItem(storageKey) || '{}');
            const monthKey = new Date().toISOString().slice(0,7);
            delete by[monthKey];
            localStorage.setItem(storageKey, JSON.stringify(by));
            // clear derived overall rate
            localStorage.removeItem('attendanceRate');
            alert('This month\'s attendance has been reset.');
            window.location.reload();
          }catch(e){console.error(e); alert('Failed to reset month.');}
        }

        document.getElementById('downloadAttendance')?.addEventListener('click', ()=> exportAttendanceCSV());
        document.getElementById('resetMonthAttendance')?.addEventListener('click', ()=> resetThisMonthAttendance());
      });
    })();
  </script>
</body>
</html>

